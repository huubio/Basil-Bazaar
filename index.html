<script>
  // ===== CONFIG =====
  const CONFIG = {
    sellerEmail: "youremail@example.com", // TODO: change this to your real receiving address
    shippingEUR: 6,
    prices: { small: 5, medium: 8 }
  };

  // Populate UI from config
  document.getElementById('price-small').textContent = CONFIG.prices.small;
  document.getElementById('price-medium').textContent = CONFIG.prices.medium;
  document.getElementById('ship').textContent = CONFIG.shippingEUR;
  document.getElementById('sellerEmailCode').textContent = CONFIG.sellerEmail;

  // ===== CART LOGIC =====
  const cart = { small: 0, medium: 0 };

  function stepQty(kind, delta){
    const inp = document.getElementById('qty-'+kind);
    const v = Math.max(0, (parseInt(inp.value||0) + delta));
    inp.value = v;
  }

  function addToCart(kind){
    const inp = document.getElementById('qty-'+kind);
    const q = Math.max(0, parseInt(inp.value||0));
    cart[kind] += q;
    inp.value = 0;
    renderCart();
  }

  function renderCart(){
    const list = document.getElementById('cartList');
    const lines = [];
    let subtotal = 0;
    for(const k of ['small','medium']){
      const qty = cart[k];
      if(!qty) continue;
      const price = CONFIG.prices[k];
      const line = qty*price;
      subtotal += line;
      lines.push(`<div>â€¢ <b>${k[0].toUpperCase()+k.slice(1)}</b> Ã— ${qty} â€” â‚¬${line}</div>`);
    }
    if(lines.length===0){ list.innerHTML = '<span class="note">No items yet â€” add some basil! ðŸŒ¿</span>'; }
    else { list.innerHTML = lines.join(''); }
    const total = subtotal>0 ? subtotal + CONFIG.shippingEUR : 0;
    document.getElementById('total').textContent = total;
  }

  function placeOrder(){
    // gather
    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim();
    const street = document.getElementById('street').value.trim();
    const postcode = document.getElementById('postcode').value.trim();
    const city = document.getElementById('city').value.trim();
    const notes = document.getElementById('notes').value.trim();

    const items = [];
    let subtotal = 0;
    for(const k of ['small','medium']){
      if(cart[k]>0){
        items.push(`${k.toUpperCase()} Ã— ${cart[k]} @ â‚¬${CONFIG.prices[k]} = â‚¬${cart[k]*CONFIG.prices[k]}`);
        subtotal += cart[k]*CONFIG.prices[k];
      }
    }
    if(items.length===0){ alert('Cart is empty. Add some basil first.'); return; }
    if(!name || !email || !street || !postcode || !city){ alert('Please fill name, email, street, postcode, and city.'); return; }

    const total = subtotal + CONFIG.shippingEUR;
    const body = encodeURIComponent(
      `New basil order\n\nItems:\n- ${items.join('\n- ')}\n\nSubtotal: â‚¬${subtotal}\nShipping (NL): â‚¬${CONFIG.shippingEUR}\nTOTAL: â‚¬${total}\n\nBuyer:\n${name}\n${street}\n${postcode} ${city}\nEmail: ${email}\nNotes: ${notes || '-'}\n\nPlease reply with payment link and ETA.`
    );
    const subject = encodeURIComponent(`Basil Order â€” ${name}`);
    const mailto = `mailto:${CONFIG.sellerEmail}?subject=${subject}&body=${body}`;
    window.location.href = mailto;
  }

  // ===== ORDER GATHER (for payments) =====
  function gatherOrder(){
    const name = document.getElementById('name').value.trim();
    const email = document.getElementById('email').value.trim();
    const street = document.getElementById('street').value.trim();
    const postcode = document.getElementById('postcode').value.trim();
    const city = document.getElementById('city').value.trim();
    const notes = document.getElementById('notes').value.trim();

    const items = [];
    let subtotal = 0;
    for(const k of ['small','medium']){
      if(cart[k]>0){
        items.push({ kind:k, qty:cart[k], unit: CONFIG.prices[k], line: cart[k]*CONFIG.prices[k] });
        subtotal += cart[k]*CONFIG.prices[k];
      }
    }
    if(items.length===0){ return { error: 'Cart is empty. Add some basil first.' }; }
    if(!name || !email || !street || !postcode || !city){ return { error: 'Please fill name, email, street, postcode, and city.' }; }
    const total = subtotal + CONFIG.shippingEUR;
    const buyer = { name, email, street, postcode, city, notes };
    return { items, subtotal, total, buyer };
  }

  // ===== START PAYMENT (Tikkie / Mollie) =====
  async function startPayment(provider){
    const order = gatherOrder();
    if(order.error){ alert(order.error); return; }
    const orderId = 'BASIL-' + Date.now();
    const desc = `${order.items.map(i => `${i.kind.toUpperCase()}x${i.qty}`).join('+')} + ship`;
    const returnUrl = location.origin + '/#thanks?o=' + encodeURIComponent(orderId);
    try{
      const res = await fetch('/api/create-payment',{
        method:'POST', headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({
          provider,
          amountEUR: Number(order.total),
          description: `Basil order ${orderId} (${desc})`,
          referenceId: orderId,
          buyer: order.buyer,
          returnUrl
        })
      });
      if(!res.ok){ const t = await res.text(); throw new Error(t||('HTTP '+res.status)); }
      const data = await res.json();
      if(!data.paymentUrl){ throw new Error('No paymentUrl from server.'); }
      // remember last order for status check
      localStorage.setItem('basil-last-ref', orderId);
      localStorage.setItem('basil-last-provider', provider);
      window.location.href = data.paymentUrl; // redirect to provider checkout
    }catch(err){
      console.error(err);
      alert('Could not start payment. You can still place order via email.');
    }
  }

  function payWithTikkie(){ startPayment('tikkie'); }
  function payWithMollie(){ startPayment('mollie'); }

  // ===== AGENT (BASI-L 1.0) =====
  const chat = document.getElementById('chat');
  const input = document.getElementById('chatInput');
  let state = { step: 'hello', choice: null, qty: 0, buyer:{} };

  function say(text, who='bot'){
    const div = document.createElement('div');
    div.className = 'msg '+(who==='me'?'me':'bot');
    div.innerHTML = text;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
  }

  function greet(){
    say(`<b>Hi! I'm BASI-L</b> ðŸ§ª Your retro order agent. I sell <b>small â‚¬${CONFIG.prices.small}</b> and <b>medium â‚¬${CONFIG.prices.medium}</b> basil plants. Shipping in NL is <b>â‚¬${CONFIG.shippingEUR}</b>. Type <code>small</code> or <code>medium</code> to start.`);
    state.step = 'size';
  }

  function send(){
    const text = input.value.trim();
    if(!text) return;
    say(text, 'me');
    input.value='';

    switch(state.step){
      case 'size':{
        const t = text.toLowerCase();
        if(t!=='small' && t!=='medium'){ say("Please type <code>small</code> or <code>medium</code>."); return; }
        state.choice = t; say(`Nice. How many <b>${t}</b> plants? (enter a number)`);
        state.step = 'qty';
        break; }
      case 'qty':{
        const n = parseInt(text,10);
        if(!(n>0)){ say('Please enter a number like 1, 2, or 3.'); return; }
        state.qty = n; say('Got it. Your name and email? (e.g., Jane Doe, jane@example.com)');
        state.step = 'nameemail';
        break; }
      case 'nameemail':{
        const parts = text.split(',');
        if(parts.length<2){ say('Please provide both name and email separated by a comma.'); return; }
        state.buyer.name = parts[0].trim();
        state.buyer.email = parts.slice(1).join(',').trim();
        say('Address line with house number?');
        state.step = 'street';
        break; }
      case 'street':{
        state.buyer.street = text; say('Postcode? (e.g., 1012 AB)'); state.step = 'postcode'; break; }
      case 'postcode':{
        state.buyer.postcode = text; say('City?'); state.step = 'city'; break; }
      case 'city':{
        state.buyer.city = text;
        const price = CONFIG.prices[state.choice];
        const subtotal = price * state.qty;
        const total = subtotal + CONFIG.shippingEUR;
        const sum = `Order summary:\n- ${state.choice.toUpperCase()} Ã— ${state.qty} @ â‚¬${price} = â‚¬${subtotal}\n- Shipping NL: â‚¬${CONFIG.shippingEUR}\nTOTAL: â‚¬${total}`;
        say(sum.replaceAll('\n','<br>'));
        say('Type <code>confirm</code> to place your order via email, or <code>cancel</code> to start over.');
        state.step = 'confirm';
        break; }
      case 'confirm':{
        const t = text.toLowerCase();
        if(t==='cancel'){ say('Cancelled. Type <code>small</code> or <code>medium</code> to start again.'); state.step='size'; return; }
        if(t!=='confirm'){ say("Please type <code>confirm</code> or <code>cancel</code>."); return; }
        // Add to cart + open email
        cart[state.choice] += state.qty;
        renderCart();
        // prefill checkout fields
        document.getElementById('name').value = state.buyer.name;
        document.getElementById('email').value = state.buyer.email;
        document.getElementById('street').value = state.buyer.street;
        document.getElementById('postcode').value = state.buyer.postcode;
        document.getElementById('city').value = state.buyer.city;

        // Compose email
        const subtotal = CONFIG.prices[state.choice] * state.qty;
        const total = subtotal + CONFIG.shippingEUR;
        const body = encodeURIComponent(
          `New basil order via BASI-L\n\nItems:\n- ${state.choice.toUpperCase()} Ã— ${state.qty} @ â‚¬${CONFIG.prices[state.choice]} = â‚¬${subtotal}\n\nSubtotal: â‚¬${subtotal}\nShipping (NL): â‚¬${CONFIG.shippingEUR}\nTOTAL: â‚¬${total}\n\nBuyer:\n${state.buyer.name}\n${state.buyer.street}\n${state.buyer.postcode} ${state.buyer.city}\nEmail: ${state.buyer.email}\n\nPlease reply with payment link and ETA.`
        );
        const subject = encodeURIComponent(`Basil Order â€” ${state.buyer.name}`);
        window.location.href = `mailto:${CONFIG.sellerEmail}?subject=${subject}&body=${body}`;
        say('âœ… Order sent! You will receive a reply with payment and shipping details.');
        state = { step: 'size', choice: null, qty: 0, buyer:{} };
        break; }
    }
  }

  // Boot agent
  greet();

  // ===== THANKS PAGE AUTO STATUS CHECK =====
  function checkThanks(){
    const hash = location.hash || '';
    if(hash.startsWith('#thanks')){
      const sec = document.getElementById('thanks');
      if(sec) sec.style.display = 'block';
      const m = hash.match(/o=([^&]+)/);
      const ref = m ? decodeURIComponent(m[1]) : (localStorage.getItem('basil-last-ref')||'');
      const statusEl = document.getElementById('payStatus');
      if(!ref){ if(statusEl) statusEl.textContent = 'No order reference found.'; return; }
      let tries = 0;
      const iv = setInterval(async ()=>{
        tries++;
        try{
          const r = await fetch(`/api/order-status?referenceId=${encodeURIComponent(ref)}`);
          const j = await r.json();
          if(statusEl) statusEl.textContent = `Status: ${j.status || 'unknown'}`;
          if(j.status==='paid' || j.status==='succeeded'){
            clearInterval(iv);
            if(statusEl) statusEl.innerHTML = 'âœ… Paid! Your basil is on its way. We\'ll confirm via email soon.';
          }
          if(tries>60) clearInterval(iv);
        }catch(e){ if(statusEl) statusEl.textContent = 'Checkingâ€¦'; }
      }, 5000);
    }
  }
  window.addEventListener('load', checkThanks);
  window.addEventListener('hashchange', checkThanks);

  // ===== FUN: VISITOR COUNTER =====
  (function(){
    const key = 'basil-counter';
    let n = parseInt(localStorage.getItem(key)||'123',10);
    n += Math.floor(Math.random()*3)+1; // bouncy
    localStorage.setItem(key, n);
    document.getElementById('counter').textContent = String(n).padStart(6,'0');
  })();
</script>
